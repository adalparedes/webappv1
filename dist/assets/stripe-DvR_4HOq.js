import{s as m,E}from"./index-B70TsQmv.js";async function g({userId:c,amount:u,orderId:d,orderDescription:s,category:i}){try{const{data:{session:r},error:l}=await m.auth.getSession();if(l||!r)throw new Error("ACCESO_RESTRINGIDO: Re-inicia sesión para procesar pagos.");const p=`${{membership:"MEM",credits:"CRE",merch:"MER",service:"SER"}[i]}_${c.substring(0,8)}_${d}`,a=E.SITE_URL.endsWith("/")?E.SITE_URL:`${E.SITE_URL}/`,t=await fetch(`${window.location.origin}/api/crypto`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.access_token}`},body:JSON.stringify({userId:c,price_amount:Number(u.toFixed(2)),price_currency:"usd",order_id:p,order_description:`[ADAL_CORE] ${s}`,category:i,success_url:`${a}dashboard?payment=success&type=${i}`,cancel_url:`${a}dashboard?payment=cancel`})});if(!t.ok){const n=await t.json();throw new Error(n.message||"Fallo en la comunicación con el nodo Crypto.")}const e=await t.json();if(e.invoice_url)window.location.href=e.invoice_url;else throw new Error(e.message||"No se pudo generar el enlace de pago Crypto.");return{success:!0}}catch(r){return console.error("[NOWPAYMENTS_ERROR]:",r.message),alert(`❌ CRYPTO ERROR: ${r.message}`),{success:!1,error:r.message}}}async function f(c){const{userId:u,userEmail:d,items:s,serviceId:i,packageIndex:r,isPricingPlan:l}=c;try{const{data:{session:o},error:R}=await m.auth.getSession();if(R||!o)throw new Error("ACCESO_RESTRINGIDO: Re-inicia sesión para procesar pagos.");const p=Array.isArray(s)?s.reduce((e,n)=>{const w=typeof n.price=="number"?n.price:0,y=typeof n.quantity=="number"?n.quantity:1;return e+w*y},0):0;console.log(`[STRIPE_INVOKE] Conectando con Vercel API Gateway para monto: $${p}...`);const a=await fetch("/api/create-stripe-session",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o.access_token}`},body:JSON.stringify({userId:u,userEmail:d,serviceId:i||(s.length===1?s[0].id:"multi_item"),packageIndex:r,isPricingPlan:l,amountUsd:p,products:s.map(e=>({sku:e.id,qty:e.quantity,category:e.type,name:e.name||e.id,price:e.price||0}))})});if(!a.ok){const e=await a.json();throw new Error(e.message||e.error||"Error al generar sesión de pago.")}const t=await a.json();if(t.url)return window.location.href=t.url,{success:!0};throw new Error("No se recibió una URL de redirección válida.")}catch(o){return console.error("[STRIPE_FATAL_ERROR]:",o.message),alert(`❌ PASARELA ERROR: ${o.message}`),{success:!1,error:o.message}}}export{g as c,f as i};
